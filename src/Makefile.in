## src/Makefile

## -- User-modifiable variables -- ##
srcdir		= @srcdir@
top_srcdir	= @top_srcdir@
subdir		= src

## == The code below shouldn't need to be touched at all == ##

include ../Rules.mk

## -- Private variables -- ##
ALL_LDFLAGS	= ${LDFLAGS} ${LIBS}

SOURCES		= ccze.c ccze-color.c ccze-plugin.c ccze-wordcolor.c \
		$(addprefix ccze-,$(addsuffix .c, ${ALL_PLUGINS})) \
		ccze-dump.c ccze-cssdump.c ccze-compat.c
HEADERS		= ccze.h ccze-color.h ccze-plugin.h ccze-wordcolor.h \
		ccze-compat.h
ALL_PLUGINS	= @ALL_PLUGINS@
S_PLUGINS	= @S_PLUGINS@
SH_PLUGINS	= $(filter-out ${S_PLUGINS},${ALL_PLUGINS})
PLUGIN_SHOBJS	= $(addsuffix .so,${SH_PLUGINS})
PLUGIN_SOBJS	= $(addsuffix .o,$(addprefix ccze-,${S_PLUGINS}))
PLUGIN_OBJS	= ${PLUGIN_SHOBJS} ${PLUGIN_SOBJS}
CLEANFILES	= ccze-dump ccze-cssdump
DISTCLEANFILES	= ccze-builtins.c
OBJECTS		= ccze.o ccze-color.o ccze-plugin.o ccze-wordcolor.o \
		ccze-builtins.o ccze-compat.o

## -- Standard targets -- ##
all: ${PROGRAM} ${PLUGIN_SHOBJS} ccze-dump ccze-cssdump

install: all
	${INSTALL} -d ${DESTDIR}${bindir}
	${INSTALL_PROGRAM} ${PROGRAM} ccze-cssdump ${DESTDIR}${bindir}/
ifneq (${SH_PLUGINS},)
		${INSTALL} -d ${DESTDIR}${pkglibdir}
		${INSTALL_DATA} ${PLUGIN_SHOBJS} ${DESTDIR}${pkglibdir}/
endif

install-strip:
	${MAKE} INSTALL_PROGRAM='${INSTALL_PROGRAM} -s' \
		INSTALL_DATA='${INSTALL_DATA} -s' install

uninstall:
	rm -f ${DESTDIR}${bindir}/${PROGRAM} ${DESTDIR}${bindir}/ccze-cssdump
ifneq (${SH_PLUGINS},)
		rm -f $(addprefix ${DESTDIR}${pkglibdir}/,${PLUGIN_SHOBJS})
endif

## -- Specific targets -- ##
${PROGRAM}: ${OBJECTS} ${PLUGIN_SOBJS}
	${CC} -rdynamic ${ALL_CFLAGS} -o $@ $^ ${ALL_LDFLAGS}
ccze-dump ccze-cssdump: %: %.o ccze-compat.o
	${CC} ${ALL_CFLAGS} -o $@ $^
ccze-builtins.c: Makefile
	echo '#include "ccze.h"' >$@
	echo '#include "ccze-plugin.h"' >>$@
	echo >>$@
	for p in ${S_PLUGINS}; do \
		echo "extern ccze_plugin_t ccze_$${p}_info;" >>$@; \
	done
	echo -e '\nvoid\nccze_plugin_load_all_builtins (void)\n{' >>$@;
	for p in ${S_PLUGINS}; do \
		echo "  ccze_plugin_add (&ccze_$${p}_info);" >>$@; \
	done
	echo "}" >>$@
%.o: %.c ccze.h ccze-plugin.h ccze-color.h ccze-wordcolor.h ccze-compat.h
	${CC} -c ${CPPFLAGS} ${ALL_CFLAGS} $<
%.so: ccze-%.c ccze.h ccze-plugin.h ccze-color.h ccze-wordcolor.h
	${CC} -fPIC -DPIC ${ALL_CFLAGS} ${ALL_LDFLAGS} -o $@ $< -shared

## -- Dependencies -- ##
ccze.o: ccze.c ${top_builddir}/system.h ccze.h ccze-color.h ccze-plugin.h \
	ccze-wordcolor.h
ccze-color.o: ccze-color.c ${top_builddir}/system.h ccze.h ccze-color.h
ccze-plugin.o: ccze-plugin.c ${top_builddir}/system.h ccze.h ccze-plugin.h
ccze-wordcolor.o: ccze-wordcolor.c ${top_builddir}/system.h ccze.h \
		  ccze-wordcolor.h
${top_builddir}/system.h: ${top_builddir}/config.status
